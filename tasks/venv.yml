---

- name: Define virtual environment full path
  set_fact:
    _virtualenv_path: >-
      {%- if virtualenv_path is search('^/') -%}
      {{ virtualenv_path }}
      {%- else -%}
      {{ python_virtualenv_root+'/'+virtualenv_path }}
      {%- endif -%}

- name: Using the following location
  debug:
    var: _virtualenv_path
    verbosity: 1

- name: Test if virtualenv already exists
  stat:
    path: "{{ _virtualenv_path }}"
  register: venv_root

- name: Delete virtualenv if recreate is required
  file:
    path: "{{ _virtualenv_path }}"
    state: absent
  become: yes
  when:
    - virtualenv_recreate|bool
    - venv_root.stat.exists|bool
    - molecule_test is not defined

- name: Make path to virtualenv
  file:
    path: "{{ _virtualenv_path }}"
    state: directory
    mode: '0755'
  register: venv_root

- name: Create virtualenv from scratch  # noqa 503
  pip:
    name:                     "pip"
    virtualenv:               "{{ _virtualenv_path }}"
    virtualenv_command:       "{{ virtualenv_command }}"
    virtualenv_python:        "{{ virtualenv_python }}"
    virtualenv_site_packages: "{{ virtualenv_site_packages }}"
  environment:
    HTTP_PROXY: "{{ python_http_proxy | default('') }}"
    HTTPS_PROXY: "{{ python_https_proxy | default('') }}"
  when:
    - venv_root.changed|bool
    - virtualenv_source == 'skip'

- name: Clone virtualenv
  include_tasks: venv_clone.yml
  vars:
    venv_source_path: "{{ virtualenv_source if virtualenv_source is search('^/') else _virtualenv_path|dirname+'/'+virtualenv_source }}"
    venv_target_path: "{{ _virtualenv_path }}"
  when: venv_root.changed|bool and virtualenv_source != 'skip'

- name: Upgrade pip to latest version
  include_tasks: pip.yml
  when: virtualenv_pip_upgrade|bool

- name: Install all pip packages
  pip:
    name: "{{ pip_package }}"
    virtualenv: "{{ _virtualenv_path }}"
    extra_args: "{{ python_trusted_hosts if python_trust_hosts|bool else omit }}"
  environment:
    HTTP_PROXY: "{{ python_http_proxy | default('') }}"
    HTTPS_PROXY: "{{ python_https_proxy | default('') }}"
  loop: "{{ virtualenv_packages }}"
  loop_control:
    loop_var: pip_package

- name: Create symlink to virtualenv
  file:
    state: link
    src: "{{ virtualenv_name }}"
    dest: "{{ _virtualenv_path|dirname }}/{{ virtualenv_label }}"
  when: virtualenv_label != 'skip'
